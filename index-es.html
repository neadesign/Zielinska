<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Pedido Desayuno Neaspace</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,600;1,500&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #fefefe;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    h1 {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      margin-bottom: 0;
    }
    h1 em {
      font-size: 18px;
      color: #666;
      display: block;
      margin-top: 5px;
    }
    .menu-header, .formule-hero, .gallery {
      max-width: 1000px;
      margin: auto;
    }
    .formule-hero {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin: 20px auto;
    }
    .gallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0 40px 0;
    }
    .gallery-item {
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow: hidden;
      text-align: center;
      font-size: 14px;
      padding: 8px;
    }
    .gallery-item img {
      width: 100%;
      height: 160px;
      object-fit: cover;
      border-radius: 6px;
    }
    button {
      padding: 12px 20px;
      font-size: 14px;
      border-radius: 8px;
      border: none;
      margin: 5px;
      cursor: pointer;
      background-color: #0077cc;
      color: white;
    }
    .summary-box {
      background: #f5f5f5;
      border-radius: 10px;
      padding: 15px;
      white-space: pre-line;
      font-size: 14px;
      margin-top: 20px;
    }
    select, input[type="date"], input[type="tel"], input[type="number"] {
      width: 100%;
      padding: 6px;
      height: 38px;
      box-sizing: border-box;
    }
    .formule-block {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 15px;
      border-radius: 8px;
      background: #f1f1f1;
      position: relative;
    }
    .remove-btn {
      position: absolute;
      top: 10px;
      right: 10px;
      background: red;
      color: white;
      border: none;
      border-radius: 50%;
      padding: 5px 10px;
      cursor: pointer;
    }
    #toastOverlay {
      display: none;
      position: fixed;
      top: 40%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0,0,0,0.85);
      color: #fff;
      padding: 20px 30px;
      border-radius: 10px;
      font-size: 16px;
      z-index: 10000;
      text-align: center;
    }
  </style>
</head>
<body>

<div id="toastOverlay">¬°Gracias! Ser√°s redirigido a la p√°gina de pago‚Ä¶</div>

<div class="menu-header">
  <img src="https://le-de.cdn-website.com/8bc9f943e09f48bb852cb048d9ca0a57/dms3rep/multi/opt/Senza-titolo-230w.png" alt="Logo Nea" height="50">
  <h1>Tu Men√∫ <em>en colaboraci√≥n con Zielinska</em></h1>
  <img src="https://delicity.b-cdn.net/public/merchants/fournil-zielinska/logo/dOX32S57QSm0SibS_200x200.jpg" alt="Logo Zielinska" height="50" style="border-radius: 8px;">
</div>

<div class="formule-hero">
  <div>
    <img src="https://raw.githubusercontent.com/neadesign/Zielinska/refs/heads/main/petdej.png" alt="F√≥rmula desayuno" style="width:100%; height:250px; object-fit:cover; border-radius:12px;">
    <p><strong>F√≥rmula Desayuno</strong><br>1 boller√≠a, 1 caf√© con leche (normal, avena o soja), 1 zumo de naranja<br><em>Un despertar suave con sabores artesanales.</em></p>
  </div>
  <div>
    <img src="https://raw.githubusercontent.com/neadesign/Zielinska/refs/heads/main/formbrunch.png" alt="F√≥rmula brunch" style="width:100%; height:250px; object-fit:cover; border-radius:12px;">
    <p><strong>F√≥rmula Brunch</strong><br>Tostada de aguacate, pan con mantequilla y mermelada, granola, bebida caliente, zumo de naranja<br><em>Un brunch generoso para empezar el d√≠a con alegr√≠a.</em></p>
  </div>
</div>
<div class="gallery">
  <div class="gallery-item">
    <img src="https://raw.githubusercontent.com/neadesign/Zielinska/refs/heads/main/avoto.png" alt="Tostada de aguacate">
    Tostada de aguacate ‚Äì Rebanada generosa con aguacate fresco
  </div>
  <div class="gallery-item">
    <img src="https://raw.githubusercontent.com/neadesign/Zielinska/refs/heads/main/panbeur.png" alt="Pan, mantequilla y mermelada">
    Pan / Mantequilla / Mermelada ‚Äì Cl√°sico de la ma√±ana
  </div>
  <div class="gallery-item">
    <img src="https://raw.githubusercontent.com/neadesign/Zielinska/refs/heads/main/babka.jpeg" alt="Babka de chocolate">
    Babka de chocolate ‚Äì Brioche trenzado con centro de chocolate
  </div>
  <div class="gallery-item">
    <img src="https://raw.githubusercontent.com/neadesign/Zielinska/refs/heads/main/roule.jpeg" alt="Rollo de canela">
    Rollo de canela ‚Äì Nuestra estrella de masa madre. ¬°Imprescindible!
  </div>
  <div class="gallery-item">
    <img src="https://raw.githubusercontent.com/neadesign/Zielinska/refs/heads/main/panbri.png" alt="Brioche con tortilla y bacon">
    Brioche con tortilla y bacon ‚Äì Trio salado y sabroso
  </div>
  <div class="gallery-item">
    <img src="https://raw.githubusercontent.com/neadesign/Zielinska/refs/heads/main/granola.png" alt="Granola">
    Granola ‚Äì Crujiente, saludable y deliciosa
  </div>
  <div class="gallery-item">
    <img src="https://raw.githubusercontent.com/neadesign/Zielinska/refs/heads/main/juisbio1.png" alt="Zumo de naranja">
    Zumo de naranja reci√©n exprimido ‚Äì 100% ecol√≥gico
  </div>
</div>

<form id="orderForm" style="max-width: 800px; margin: auto;">
  <label>Fecha de entrega: <input type="date" id="deliveryDate" name="delivery_date" required></label>
  <label>Hora:
    <select name="delivery_time" required>
      <option value="">Selecciona</option>
      <option>07:30</option><option>08:00</option><option>08:30</option>
      <option>09:00</option><option>09:30</option><option>10:00</option>
    </select>
  </label>
  <label>N√∫mero de WhatsApp: <input type="tel" name="whatsapp" required placeholder="+34 6..."></label>

  <div style="margin: 20px 0;">
    <button type="button" onclick="addFormula('petitdej')">+ A√±adir f√≥rmula Desayuno</button>
    <button type="button" onclick="addFormula('brunch')">+ A√±adir f√≥rmula Brunch</button>
  </div>

  <div id="formuleContainer"></div>

  <h2>Suplementos</h2>
  <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px;">
    <label>Tostada de aguacate ‚Äì 16.5 ‚Ç¨ <input type="number" name="addon_avocado" min="0" max="5" value="0"></label>
    <label>Pan / Mantequilla / Mermelada ‚Äì 9.5 ‚Ç¨ <input type="number" name="addon_pain" min="0" max="5" value="0"></label>
    <label>Tortilla y bacon en brioche ‚Äì 10 ‚Ç¨ <input type="number" name="addon_brioche" min="0" max="5" value="0"></label>
    <label>Granola ‚Äì 12.5 ‚Ç¨ <input type="number" name="addon_granola" min="0" max="5" value="0"></label>
    <label>Zumo de naranja ‚Äì 6.5 ‚Ç¨ <input type="number" name="addon_jus" min="0" max="5" value="0"></label>
    <label>Caf√© ‚Äì 4 ‚Ç¨ <input type="number" name="addon_cafe" min="0" max="5" value="0"></label>
    <label>Espresso ‚Äì 2.5 ‚Ç¨ <input type="number" name="addon_espresso" min="0" max="5" value="0"></label>
    <label>Latte (normal) ‚Äì 6.5 ‚Ç¨ <input type="number" name="addon_latte_normal" min="0" max="5" value="0"></label>
    <label>Latte (avena) ‚Äì 6.5 ‚Ç¨ <input type="number" name="addon_latte_avoine" min="0" max="5" value="0"></label>
    <label>Latte (soja) ‚Äì 6.5 ‚Ç¨ <input type="number" name="addon_latte_soja" min="0" max="5" value="0"></label>
  </div>

  <p style="margin-top: 20px; font-style: italic;">* Entrega 7 ‚Ç¨ con nuestro socio Delicity.</p>

  <button type="button" onclick="generateSummary()">üß∫ A√±adir al carrito</button>
  <pre id="orderSummary" style="display:none;"></pre>
  <button type="submit">‚úÖ Proceder al pago</button>
</form>
<script>
let formuleId = 0;

function addFormula(type) {
  formuleId++;
  const div = document.createElement('div');
  div.className = 'formule-block';
  div.id = 'formule_' + formuleId;
  let html = '<button class="remove-btn" onclick="removeFormula(\'' + div.id + '\')">√ó</button>';

  if (type === 'petitdej') {
    html += `<strong>Desayuno ‚Äì 13 ‚Ç¨</strong><br>
    <label>Elige boller√≠a:
      <select name="petitdej_${formuleId}_viennoiserie">
        <option value="">Selecciona</option>
        <option value="Rollo de canela">Rollo de canela</option>
        <option value="Babka">Babka</option>
        <option value="Brioche de frutas">Brioche de frutas</option>
      </select>
    </label><br>
    <label>Tipo de leche:
      <select name="petitdej_${formuleId}_lait">
        <option value="">Selecciona</option>
        <option value="Leche normal">Leche normal</option>
        <option value="Leche de avena">Leche de avena</option>
        <option value="Leche de soja">Leche de soja</option>
      </select>
    </label>`;
  } else {
    html += `<strong>Brunch ‚Äì 22 ‚Ç¨</strong><br>
    <label>Bebida caliente:
      <select name="brunch_${formuleId}">
        <option value="">Selecciona</option>
        <option value="Caf√©">Caf√©</option>
        <option value="Espresso">Espresso</option>
      </select>
    </label>`;
  }

  div.innerHTML += html;
  document.getElementById('formuleContainer').appendChild(div);
}

function removeFormula(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}

function generateSummary() {
  const dateInput = document.querySelector('[name="delivery_date"]').value;
  const timeInput = document.querySelector('[name="delivery_time"]').value;
  const phoneInput = document.querySelector('[name="whatsapp"]').value;

  if (isInvalid(dateInput)) {
    alert("‚ùå Esta fecha no est√° disponible. Por favor, elige otra.");
    return;
  }

  if (!dateInput || !timeInput || !phoneInput) {
    alert("Por favor, completa la fecha de entrega, hora y n√∫mero de WhatsApp.");
    return;
  }

  const today = new Date();
  const deliveryDate = new Date(dateInput + 'T00:00:00');
  const now = new Date();
  const isSameDay = today.toDateString() === deliveryDate.toDateString();
  const isTomorrow = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).toDateString() === deliveryDate.toDateString();
  const currentHour = now.getHours();

  if (isSameDay || (isTomorrow && currentHour >= 18)) {
    alert("‚ùå Los pedidos deben realizarse el d√≠a anterior antes de las 18:00.");
    return;
  }

  let summary = `üìÖ Entrega: ${dateInput} a las ${timeInput}
üìç Direcci√≥n: 19 Rue Neuve, Niza ‚Äì 2¬∞ piso, puerta derecha (üîî Rossi-Lamrabet)
üì± WhatsApp: ${phoneInput}
`;

  let total = 0;
  const prices = { petitdej: 13, brunch: 22 };

  document.querySelectorAll('.formule-block').forEach(block => {
    const selects = block.querySelectorAll('select');

    if (block.querySelector('select[name^="petitdej"]')) {
      const pastry = selects[0]?.value || 'no especificado';
      const milk = selects[1]?.value || 'no especificado';

      summary += `\nDesayuno ‚Äì 13 ‚Ç¨:\n` +
                 `- Boller√≠a: ${pastry}\n` +
                 `- Caf√© con leche: ${milk}\n` +
                 `- Zumo de naranja\n`;
      total += prices.petitdej;
    }

    if (block.querySelector('select[name^="brunch"]')) {
      const drink = selects[0]?.value || 'no especificado';

      summary += `\nBrunch ‚Äì 22 ‚Ç¨:\n` +
                 `- Tostada de aguacate\n` +
                 `- Pan, mantequilla y mermelada\n` +
                 `- Granola\n` +
                 `- Bebida caliente: ${drink}\n` +
                 `- Zumo de naranja\n`;
      total += prices.brunch;
    }
  });

  const addons = [
    ["addon_avocado", "Tostada de aguacate", 16.5],
    ["addon_pain", "Pan / Mantequilla / Mermelada", 9.5],
    ["addon_brioche", "Tortilla y bacon en brioche", 10],
    ["addon_granola", "Granola", 12.5],
    ["addon_jus", "Zumo de naranja", 6.5],
    ["addon_cafe", "Caf√©", 4],
    ["addon_espresso", "Espresso", 2.5],
    ["addon_latte_normal", "Latte (normal)", 6.5],
    ["addon_latte_avoine", "Latte (avena)", 6.5],
    ["addon_latte_soja", "Latte (soja)", 6.5]
  ];

  addons.forEach(([name, label, price]) => {
    const el = document.querySelector(`[name="${name}"]`);
    const qty = parseInt(el?.value || 0);
    if (qty > 0) {
      summary += `${label} (${price} ‚Ç¨) ‚Äì Cantidad: ${qty}\n`;
      total += qty * price;
    }
  });

  summary += `\nüöö Entrega: 7 ‚Ç¨ con Delicity.`;
  total += 7;
  summary += `\nüí∞ Total: ${total.toFixed(2)} ‚Ç¨`;

  document.getElementById('orderSummary').style.display = 'block';
  document.getElementById('orderSummary').textContent = summary;
}

function generateStripeSummary() {
  const summary = document.getElementById("orderSummary").textContent;
  const maxLength = 500;
  if (summary.length <= maxLength) return summary;

  const date = document.querySelector('[name="delivery_date"]').value;
  const time = document.querySelector('[name="delivery_time"]').value;
  const phone = document.querySelector('[name="whatsapp"]').value;
  const count = document.querySelectorAll('.formule-block').length;

  return `Fecha: ${date} ${time}, Cliente: ${phone}, F√≥rmulas: ${count}, Total: ${summary.match(/Total: ([\d.,]+)/)?.[1]} ‚Ç¨`;
}

document.getElementById("orderForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const summary = document.getElementById("orderSummary").textContent;
  const totalMatch = summary.match(/Total: ([\d.,]+)/);
  const total = totalMatch ? parseFloat(totalMatch[1].replace(',', '.')) : 0;

  const toast = document.getElementById('toastOverlay');
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, 8000);

  fetch('https://Zielinska.onrender.com/create-checkout-session', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      total,
      orderDetails: summary,
      stripeSummary: generateStripeSummary(),
      delivery_date: document.querySelector('[name="delivery_date"]').value
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.url) {
      window.location.href = data.url;
    } else {
      alert("‚ùå El pago no est√° disponible en este momento. Intenta m√°s tarde.");
    }
  })
  .catch(err => {
    console.error("‚ùå Error con Stripe:", err);
    alert("‚ùå Ocurri√≥ un error durante el pago.");
  });
});

// Validaci√≥n fechas bloqueadas desde Google Sheets
const START_DATE = new Date("2025-05-23");
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vScTm1j0tp3F7h89bhmLGqEJr4nlJuqPCPm8j57qn3xqFfIYk3Mf89KXRWqbxzmxA/pub?output=csv";
let unavailableDatesFromSheet = [];

async function fetchUnavailableDates() {
  try {
    const response = await fetch(sheetUrl);
    const text = await response.text();
    const rows = text.split('\n');
    unavailableDatesFromSheet = rows
      .map(row => row.trim())
      .filter(r => r.match(/^\d{4}-\d{2}-\d{2}$/));
  } catch (err) {
    console.error("‚ùå Error al cargar fechas bloqueadas:", err);
  }
}

function isWednesday(dateStr) {
  const d = new Date(dateStr);
  return d.getDay() === 3;
}

function isInvalid(dateStr) {
  const d = new Date(dateStr);
  return (
    isNaN(d) ||
    d < START_DATE ||
    isWednesday(dateStr) ||
    unavailableDatesFromSheet.includes(dateStr)
  );
}

window.addEventListener('DOMContentLoaded', async () => {
  await fetchUnavailableDates();
  const dateInput = document.getElementById('deliveryDate');
  let timeout;
  dateInput.addEventListener('input', () => {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
      const selectedDate = dateInput.value;
      if (isInvalid(selectedDate)) {
        alert("‚ùå Fecha no disponible. Elige otra.");
        dateInput.value = "";
      }
    }, 800);
  });
});
</script>
</body>
</html>
