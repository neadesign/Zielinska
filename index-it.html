<!DOCTYPE html>
<html lang="it">
<head>

<style>
  #toastOverlay {
    display: none;
    position: fixed;
    top: 40%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(0,0,0,0.85);
    color: #fff;
    padding: 20px 30px;
    border-radius: 10px;
    font-size: 16px;
    z-index: 10000;
    text-align: center;
  }
</style>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&family=Playfair+Display:ital,wght@0,600;1,500&display=swap" rel="stylesheet">
<style>
  body {
    font-family: 'Inter', sans-serif;
  }
  h1 {
    font-family: 'Playfair Display', serif;
    font-weight: 600;
    font-size: 28px;
  }
  h1 em {
    font-family: 'Playfair Display', serif;
    font-weight: 500;
    font-size: 18px;
    color: #666;
  }
</style>

<style>
  body {
    font-family: 'Lato', sans-serif;
    background-color: #fefefe;
    margin: 0;
    padding: 20px;
    color: #333;
  }
  h1 {
    font-size: 28px;
    margin-bottom: 0;
  }
  h1 em {
    font-size: 18px;
    color: #666;
    display: block;
    margin-top: 5px;
  }
  .menu-header {
    text-align: center;
    margin-bottom: 30px;
  }
  .gallery {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin: 20px auto 40px auto;
    max-width: 1000px;
  }
  .gallery-item {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    overflow: hidden;
    text-align: center;
    font-size: 14px;
    padding: 8px;
    transition: transform 0.3s ease;
  }
  .gallery-item:hover {
    transform: scale(1.02);
  }
  .gallery-item img {
    width: 100%;
    height: 160px;
    object-fit: cover;
    border-radius: 6px;
  }
</style>

<meta charset="UTF-8">
<title>Ordina colazione - Neaspace</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<div id="toastOverlay">Grazie, verrai reindirizzato alla pagina di pagamentoâ€¦</div>
<script>
function generateSummary() {
  const dateInput = document.querySelector('[name="delivery_date"]').value;
  const timeInput = document.querySelector('[name="delivery_time"]').value;
  const phoneInput = document.querySelector('[name="whatsapp"]').value;

  if (!dateInput || !timeInput || !phoneInput) {
    alert("âŒ Inserisci data, ora e numero WhatsApp.");
    return;
  }

  const today = new Date();
  const deliveryDate = new Date(dateInput + 'T00:00:00');
  const now = new Date();
  const isSameDay = today.toDateString() === deliveryDate.toDateString();
  const isTomorrow = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).toDateString() === deliveryDate.toDateString();
  const currentHour = now.getHours();

  if (isSameDay || (isTomorrow && currentHour >= 18)) {
    alert("âŒ Ordina almeno il giorno prima, entro le 18:00.");
    return;
  }

  let summary = `ðŸ“… Consegna: ${dateInput} alle ${timeInput}\nðŸ“± Contatto: ${phoneInput}\n`;
  let total = 0;

  const prezzi = { petitdej: 13, brunch: 22 };

  document.querySelectorAll('.formule-block').forEach(block => {
    const selects = block.querySelectorAll('select');
    if (block.querySelector('select[name^="petitdej"]')) {
      const viennoiserie = selects[0]?.value || 'non specificato';
      const latte = selects[1]?.value || 'non specificato';
      summary += `\nðŸž Colazione â€“ 13 â‚¬:\n- Viennoiserie: ${viennoiserie}\n- Latte: ${latte}\n- Succo dâ€™arancia\n`;
      total += prezzi.petitdej;
    }
    if (block.querySelector('select[name^="brunch"]')) {
      const bevanda = selects[0]?.value || 'non specificato';
      summary += `\nðŸ¥‘ Brunch â€“ 22 â‚¬:\n- Avocado toast\n- Pane, burro e marmellata\n- Granola\n- Bevanda: ${bevanda}\n- Succo dâ€™arancia\n`;
      total += prezzi.brunch;
    }
  });

  const addons = [
    ["addon_avocado", "Avocado toast", 16.5],
    ["addon_pain", "Pane / Burro / Marmellata", 9.5],
    ["addon_brioche", "Omelette e bacon", 10],
    ["addon_granola", "Granola", 12.5],
    ["addon_jus", "Succo dâ€™arancia", 6.5],
    ["addon_cafe", "CaffÃ¨", 4],
    ["addon_espresso", "Espresso", 2.5],
    ["addon_latte_normal", "Latte normale", 6.5],
    ["addon_latte_avoine", "Latte avena", 6.5],
    ["addon_latte_soja", "Latte soia", 6.5]
  ];

  addons.forEach(([name, label, price]) => {
    const el = document.querySelector(`[name="${name}"]`);
    const qty = parseInt(el?.value || 0);
    if (qty > 0) {
      summary += `âž• ${label} (${price} â‚¬) Ã— ${qty}\n`;
      total += qty * price;
    }
  });

  summary += `\nðŸšš Consegna: 7 â‚¬ tramite Delicity\nðŸ’° Totale: ${total + 7} â‚¬`;

  const output = document.getElementById("orderSummary");
  output.textContent = summary;
  output.style.display = "block";
}

document.getElementById("orderForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const summary = document.getElementById("orderSummary").textContent;
  const totalMatch = summary.match(/Totale: ([\\d.,]+)/);
  const total = totalMatch ? parseFloat(totalMatch[1].replace(',', '.')) : 0;

  const toast = document.getElementById('toastOverlay');
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, 8000);

  fetch('https://Zielinska.onrender.com/create-checkout-session', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      total,
      orderDetails: summary,
      stripeSummary: `Totale: ${total} â‚¬, Cliente: ${document.querySelector('[name=\"whatsapp\"]').value}`,
      delivery_date: document.querySelector('[name=\"delivery_date\"]').value
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.url) {
      window.location.href = data.url;
    } else {
      alert("âŒ Errore durante il pagamento.");
    }
  })
  .catch(err => {
    console.error(err);
    alert("âŒ Errore durante la connessione a Stripe.");
  });
});

const START_DATE = new Date("2025-05-23");
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vScTm1j0tp3F7h89bhmLGqEJr4nlJuqPCPm8j57qn3xqFfIYk3Mf89KXRWqbxzmxA/pub?output=csv";
let unavailableDatesFromSheet = [];

async function fetchUnavailableDates() {
  try {
    const response = await fetch(sheetUrl);
    const text = await response.text();
    const rows = text.split('\\n');
    unavailableDatesFromSheet = rows.map(row => row.trim()).filter(r => /^\\d{4}-\\d{2}-\\d{2}$/.test(r));
  } catch (err) {
    console.error(\"Errore caricamento date bloccate:\", err);
  }
}

function isInvalid(dateStr) {
  const d = new Date(dateStr);
  return (
    isNaN(d) ||
    d < START_DATE ||
    d.getDay() === 3 || // mercoledÃ¬ chiuso
    unavailableDatesFromSheet.includes(dateStr)
  );
}

window.addEventListener('DOMContentLoaded', async () => {
  await fetchUnavailableDates();
  const today = new Date();
  const next = [];
  for (let i = 0; i < 15; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() + i);
    const iso = d.toISOString().split('T')[0];
    if (isInvalid(iso)) next.push(iso);
    if (next.length >= 3) break;
  }
  document.getElementById("nextUnavailable").textContent =
    `âš ï¸ Prossime date non disponibili: ${next.map(d => new Date(d).toLocaleDateString('it-IT')).join(', ')}`;
});
</script>
<script>
function generateSummary() {
  const dateInput = document.querySelector('[name="delivery_date"]').value;
  const timeInput = document.querySelector('[name="delivery_time"]').value;
  const phoneInput = document.querySelector('[name="whatsapp"]').value;

  if (!dateInput || !timeInput || !phoneInput) {
    alert("âŒ Inserisci data, ora e numero WhatsApp.");
    return;
  }

  const today = new Date();
  const deliveryDate = new Date(dateInput + 'T00:00:00');
  const now = new Date();
  const isSameDay = today.toDateString() === deliveryDate.toDateString();
  const isTomorrow = new Date(today.getFullYear(), today.getMonth(), today.getDate() + 1).toDateString() === deliveryDate.toDateString();
  const currentHour = now.getHours();

  if (isSameDay || (isTomorrow && currentHour >= 18)) {
    alert("âŒ Ordina almeno il giorno prima, entro le 18:00.");
    return;
  }

  let summary = `ðŸ“… Consegna: ${dateInput} alle ${timeInput}\nðŸ“± Contatto: ${phoneInput}\n`;
  let total = 0;

  const prezzi = { petitdej: 13, brunch: 22 };

  document.querySelectorAll('.formule-block').forEach(block => {
    const selects = block.querySelectorAll('select');
    if (block.querySelector('select[name^="petitdej"]')) {
      const viennoiserie = selects[0]?.value || 'non specificato';
      const latte = selects[1]?.value || 'non specificato';
      summary += `\nðŸž Colazione â€“ 13 â‚¬:\n- Viennoiserie: ${viennoiserie}\n- Latte: ${latte}\n- Succo dâ€™arancia\n`;
      total += prezzi.petitdej;
    }
    if (block.querySelector('select[name^="brunch"]')) {
      const bevanda = selects[0]?.value || 'non specificato';
      summary += `\nðŸ¥‘ Brunch â€“ 22 â‚¬:\n- Avocado toast\n- Pane, burro e marmellata\n- Granola\n- Bevanda: ${bevanda}\n- Succo dâ€™arancia\n`;
      total += prezzi.brunch;
    }
  });

  const addons = [
    ["addon_avocado", "Avocado toast", 16.5],
    ["addon_pain", "Pane / Burro / Marmellata", 9.5],
    ["addon_brioche", "Omelette e bacon", 10],
    ["addon_granola", "Granola", 12.5],
    ["addon_jus", "Succo dâ€™arancia", 6.5],
    ["addon_cafe", "CaffÃ¨", 4],
    ["addon_espresso", "Espresso", 2.5],
    ["addon_latte_normal", "Latte normale", 6.5],
    ["addon_latte_avoine", "Latte avena", 6.5],
    ["addon_latte_soja", "Latte soia", 6.5]
  ];

  addons.forEach(([name, label, price]) => {
    const el = document.querySelector(`[name="${name}"]`);
    const qty = parseInt(el?.value || 0);
    if (qty > 0) {
      summary += `âž• ${label} (${price} â‚¬) Ã— ${qty}\n`;
      total += qty * price;
    }
  });

  summary += `\nðŸšš Consegna: 7 â‚¬ tramite Delicity\nðŸ’° Totale: ${total + 7} â‚¬`;

  const output = document.getElementById("orderSummary");
  output.textContent = summary;
  output.style.display = "block";
}

document.getElementById("orderForm").addEventListener("submit", function(e) {
  e.preventDefault();
  const summary = document.getElementById("orderSummary").textContent;
  const totalMatch = summary.match(/Totale: ([\\d.,]+)/);
  const total = totalMatch ? parseFloat(totalMatch[1].replace(',', '.')) : 0;

  const toast = document.getElementById('toastOverlay');
  toast.style.display = 'block';
  setTimeout(() => { toast.style.display = 'none'; }, 8000);

  fetch('https://Zielinska.onrender.com/create-checkout-session', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      total,
      orderDetails: summary,
      stripeSummary: `Totale: ${total} â‚¬, Cliente: ${document.querySelector('[name=\"whatsapp\"]').value}`,
      delivery_date: document.querySelector('[name=\"delivery_date\"]').value
    })
  })
  .then(res => res.json())
  .then(data => {
    if (data.url) {
      window.location.href = data.url;
    } else {
      alert("âŒ Errore durante il pagamento.");
    }
  })
  .catch(err => {
    console.error(err);
    alert("âŒ Errore durante la connessione a Stripe.");
  });
});

const START_DATE = new Date("2025-05-23");
const sheetUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vScTm1j0tp3F7h89bhmLGqEJr4nlJuqPCPm8j57qn3xqFfIYk3Mf89KXRWqbxzmxA/pub?output=csv";
let unavailableDatesFromSheet = [];

async function fetchUnavailableDates() {
  try {
    const response = await fetch(sheetUrl);
    const text = await response.text();
    const rows = text.split('\\n');
    unavailableDatesFromSheet = rows.map(row => row.trim()).filter(r => /^\\d{4}-\\d{2}-\\d{2}$/.test(r));
  } catch (err) {
    console.error(\"Errore caricamento date bloccate:\", err);
  }
}

function isInvalid(dateStr) {
  const d = new Date(dateStr);
  return (
    isNaN(d) ||
    d < START_DATE ||
    d.getDay() === 3 || // mercoledÃ¬ chiuso
    unavailableDatesFromSheet.includes(dateStr)
  );
}

window.addEventListener('DOMContentLoaded', async () => {
  await fetchUnavailableDates();
  const today = new Date();
  const next = [];
  for (let i = 0; i < 15; i++) {
    const d = new Date(today);
    d.setDate(today.getDate() + i);
    const iso = d.toISOString().split('T')[0];
    if (isInvalid(iso)) next.push(iso);
    if (next.length >= 3) break;
  }
  document.getElementById("nextUnavailable").textContent =
    `âš ï¸ Prossime date non disponibili: ${next.map(d => new Date(d).toLocaleDateString('it-IT')).join(', ')}`;
});
</script>

<script>
let formuleId = 0;

function addFormula(type) {
  formuleId++;
  const div = document.createElement('div');
  div.className = 'formule-block';
  div.id = 'formule_' + formuleId;
  let html = '<button class="remove-btn" onclick="removeFormula(\'' + div.id + '\')">Ã—</button>';

  if (type === 'petitdej') {
    html += `<strong>Colazione â€“ 13 â‚¬</strong><br>
    <label>Tipo di viennoiserie:
      <select class="formule-select" name="petitdej_${formuleId}_viennoiserie">
        <option value="">Seleziona</option>
        <option value="Girella">Girella</option>
        <option value="Babka">Babka</option>
        <option value="Brioche">Brioche</option>
      </select>
    </label><br>
    <label>Tipo di latte:
      <select class="formule-select" name="petitdej_${formuleId}_lait">
        <option value="">Seleziona</option>
        <option value="Latte normale">Latte normale</option>
        <option value="Latte d'avena">Latte d'avena</option>
        <option value="Latte di soia">Latte di soia</option>
      </select>
    </label>`;
  } else {
    html += `<strong>Brunch â€“ 22 â‚¬</strong><br>
    <label>Bevanda calda:
      <select class="formule-select" name="brunch_${formuleId}">
        <option value="">Seleziona</option>
        <option value="CaffÃ¨">CaffÃ¨</option>
        <option value="Espresso">Espresso</option>
      </select>
    </label>`;
  }

  div.innerHTML += html;
  document.getElementById('formuleContainer').appendChild(div);
}

function removeFormula(id) {
  const el = document.getElementById(id);
  if (el) el.remove();
}
</script>
</body>
</html>
